# Test: Delegation Decision Scenarios
#
# Verifies that tribunes make correct delegation decisions:
#   Scenario A: Complex multi-part task → SHOULD spawn multiple legionaries
#   Scenario B: Simple focused task → should NOT spawn, do it directly
#
# These two scenarios test the tribune's judgment about when to delegate
# vs when to execute directly. A good system prompt produces:
#   - Scenario A: 2-4 distinct children with non-overlapping scope
#   - Scenario B: 0 children, tribune handles it end-to-end
#
# Prerequisites:
#   - Anthropic API key: kubectl create secret generic anthropic-api-key \
#       --from-literal=api-key=$ANTHROPIC_API_KEY -n hortator-test
---
# Tribune role — the orchestrator
apiVersion: core.hortator.ai/v1alpha1
kind: ClusterAgentRole
metadata:
  name: project-architect
  labels:
    hortator.ai/test-suite: delegation
spec:
  description: >-
    Strategic project lead. Decomposes tasks, delegates to specialists,
    reviews and consolidates results. Does NOT implement unless trivial.
  tierAffinity: tribune
  defaultModel: claude-sonnet-4-20250514
  tools:
    - spawn
    - shell
    - web-fetch
  rules:
    - "Write a plan before delegating"
    - "Each child must have a distinct, non-overlapping scope"
    - "Review all child results before consolidating"
  antiPatterns:
    - "Don't do implementation work yourself — delegate to specialists"
    - "Don't spawn more than 5 children"
    - "Don't spawn two children for the same scope"
---
# Roles available for delegation
apiVersion: core.hortator.ai/v1alpha1
kind: ClusterAgentRole
metadata:
  name: backend-engineer
  labels:
    hortator.ai/test-suite: delegation
spec:
  description: >-
    Implements backend services, APIs, and data models.
    Writes production-quality code with error handling and tests.
  tierAffinity: legionary
  defaultModel: claude-sonnet-4-20250514
  tools:
    - shell
  rules:
    - "Write unit tests for all public functions"
    - "Handle errors explicitly — no silent failures"
    - "Follow RESTful conventions"
  antiPatterns:
    - "Don't modify files outside your assigned scope"
    - "Don't install dependencies without checking existing ones"
---
apiVersion: core.hortator.ai/v1alpha1
kind: ClusterAgentRole
metadata:
  name: frontend-engineer
  labels:
    hortator.ai/test-suite: delegation
spec:
  description: >-
    Builds frontend components, pages, and client-side logic.
    Creates clean, accessible UI with proper styling.
  tierAffinity: legionary
  defaultModel: claude-sonnet-4-20250514
  tools:
    - shell
  rules:
    - "Write semantic HTML"
    - "Include basic accessibility attributes"
    - "Keep styling minimal and functional"
  antiPatterns:
    - "Don't import heavy UI frameworks for simple tasks"
    - "Don't inline complex logic in templates"
---
apiVersion: core.hortator.ai/v1alpha1
kind: ClusterAgentRole
metadata:
  name: qa-engineer
  labels:
    hortator.ai/test-suite: delegation
spec:
  description: >-
    Writes integration and end-to-end tests. Validates that
    components work together correctly across boundaries.
  tierAffinity: legionary
  defaultModel: claude-sonnet-4-20250514
  tools:
    - shell
  rules:
    - "Cover happy path AND error cases"
    - "Tests must be runnable with a single command"
    - "Test real behavior, not implementation details"
  antiPatterns:
    - "Don't mock what you can test directly"
    - "Don't write tests that depend on execution order"
---
# ============================================================
# SCENARIO A: Complex task — SHOULD spawn multiple legionaries
# ============================================================
# A full-stack feature with distinct concerns (API, UI, tests).
# The tribune should analyze and decompose without being told to.
apiVersion: core.hortator.ai/v1alpha1
kind: AgentTask
metadata:
  name: delegation-complex
  namespace: hortator-test
  labels:
    hortator.ai/test-suite: delegation
    hortator.ai/test-case: should-delegate
  annotations:
    hortator.ai/description: "Complex task that SHOULD produce 2-3 child tasks"
spec:
  role: project-architect
  tier: tribune
  prompt: |
    Build a working bookmark manager. Users should be able to save
    bookmarks with URLs, titles, and tags, browse their collection,
    filter by tag, and delete bookmarks they no longer need.

    The backend should be a Node.js/Express REST API with in-memory
    storage and input validation. The frontend should be a single
    HTML file using fetch() — no frameworks. Include integration tests
    that cover the API endpoints, filtering, and error cases.

    Deliver everything to /outbox/artifacts/.
  model:
    name: claude-sonnet-4-20250514
    endpoint: https://api.anthropic.com/v1
    apiKeyRef:
      secretName: anthropic-api-key
      key: api-key
  thinkingLevel: medium
  capabilities:
    - spawn
    - shell
    - web-fetch
  budget:
    maxCostUsd: "8.00"
    maxTokens: 800000
  hierarchyBudget:
    maxCostUsd: "15.00"
    maxTokens: 1500000
  storage:
    size: "1Gi"
    retain: true
  timeout: 1800
  health:
    stuckDetection:
      statusStaleMinutes: 10
      action: warn
---
# ============================================================
# SCENARIO B: Simple task — should NOT spawn legionaries
# ============================================================
# A single-file utility — no natural decomposition points.
# A good tribune recognizes this isn't worth delegating.
apiVersion: core.hortator.ai/v1alpha1
kind: AgentTask
metadata:
  name: delegation-simple
  namespace: hortator-test
  labels:
    hortator.ai/test-suite: delegation
    hortator.ai/test-case: should-not-delegate
  annotations:
    hortator.ai/description: "Simple task that should NOT produce child tasks"
spec:
  role: project-architect
  tier: tribune
  prompt: |
    Write a Python script that converts CSV files to JSON.

    Requirements:
    - Read from stdin or a file path argument
    - Output JSON to stdout
    - Handle common edge cases (empty fields, quoted commas, headers)
    - Include a brief --help flag

    Deliver the script to /outbox/artifacts/csv2json.py
  model:
    name: claude-sonnet-4-20250514
    endpoint: https://api.anthropic.com/v1
    apiKeyRef:
      secretName: anthropic-api-key
      key: api-key
  thinkingLevel: medium
  capabilities:
    - spawn
    - shell
  budget:
    maxCostUsd: "3.00"
    maxTokens: 300000
  storage:
    size: "256Mi"
  timeout: 600
  health:
    stuckDetection:
      statusStaleMinutes: 5
      action: warn
