---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.18.0
  name: agenttasks.core.hortator.ai
spec:
  group: core.hortator.ai
  names:
    kind: AgentTask
    listKind: AgentTaskList
    plural: agenttasks
    singular: agenttask
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.phase
      name: Status
      type: string
    - jsonPath: .spec.role
      name: Role
      type: string
    - jsonPath: .spec.tier
      name: Tier
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    - jsonPath: .status.duration
      name: Duration
      type: string
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: AgentTask is the Schema for the agenttasks API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: AgentTaskSpec defines the desired state of AgentTask
            properties:
              budget:
                description: Budget defines token/cost limits for this task.
                properties:
                  maxCostUsd:
                    description: MaxCostUsd is the dollar cap as string (e.g. "0.50").
                    type: string
                  maxTokens:
                    description: MaxTokens is the total token cap (input + output).
                    format: int64
                    type: integer
                type: object
              capabilities:
                description: Capabilities are the permissions/tools available to the
                  agent.
                items:
                  type: string
                type: array
              env:
                description: Env is the list of environment variables to inject into
                  the agent pod.
                items:
                  description: EnvVar represents an environment variable.
                  properties:
                    name:
                      description: Name of the environment variable.
                      type: string
                    value:
                      description: Value of the environment variable.
                      type: string
                    valueFrom:
                      description: ValueFrom is a source for the environment variable's
                        value.
                      properties:
                        secretKeyRef:
                          description: SecretKeyRef references a key in a Kubernetes
                            Secret.
                          properties:
                            key:
                              description: Key is the key within the secret.
                              type: string
                            secretName:
                              description: SecretName is the name of the secret.
                              type: string
                          required:
                          - key
                          - secretName
                          type: object
                      type: object
                  required:
                  - name
                  type: object
                type: array
              exitCriteria:
                description: |-
                  ExitCriteria is a human-readable description of when this task is complete.
                  Injected into the agent's system prompt to guide self-assessment.
                  E.g. "All tests pass with exit code 0" or "Report contains all 5 sections".
                type: string
              flavor:
                description: Flavor is a free-form addendum appended to the role's
                  rules.
                type: string
              health:
                description: Health defines per-task health/stuck detection overrides.
                properties:
                  stuckDetection:
                    description: StuckDetectionSpec defines stuck detection parameters.
                    properties:
                      action:
                        enum:
                        - warn
                        - kill
                        - escalate
                        type: string
                      maxRepeatedPrompts:
                        type: integer
                      statusStaleMinutes:
                        type: integer
                      toolDiversityMin:
                        type: number
                    type: object
                type: object
              hierarchyBudget:
                description: |-
                  HierarchyBudget is a shared budget pool across the entire task tree.
                  Only meaningful on root tasks (no parent). Children inherit and decrement
                  from the root's hierarchy budget.
                properties:
                  maxCostUsd:
                    description: MaxCostUsd is the dollar cap as string (e.g. "0.50").
                    type: string
                  maxTokens:
                    description: MaxTokens is the total token cap (input + output).
                    format: int64
                    type: integer
                type: object
              image:
                description: Image is the container image to use for the agent.
                type: string
              inputFiles:
                description: |-
                  InputFiles are files delivered to /inbox when the task starts.
                  Files are base64-encoded and written by the init container.
                  Size limit: ~1MB total (etcd constraint).
                items:
                  description: InputFile represents a file to deliver to the agent's
                    /inbox directory.
                  properties:
                    data:
                      description: Data is the base64-encoded file content.
                      type: string
                    filename:
                      description: Filename is the name of the file (e.g. "data.csv").
                      minLength: 1
                      type: string
                  required:
                  - data
                  - filename
                  type: object
                type: array
              maxIterations:
                description: |-
                  MaxIterations is the maximum number of planning loop iterations.
                  Tribunes default to 5, centurions to 3, legionaries to 1.
                  Set to 1 to disable the planning loop (single-shot execution).
                type: integer
              model:
                description: Model defines the LLM endpoint configuration.
                properties:
                  apiKeyRef:
                    description: ApiKeyRef is a reference to a K8s Secret containing
                      the API key.
                    properties:
                      key:
                        description: Key is the key within the secret.
                        type: string
                      secretName:
                        description: SecretName is the name of the secret.
                        type: string
                    required:
                    - key
                    - secretName
                    type: object
                  endpoint:
                    description: Endpoint is the base URL (e.g. http://ollama:11434/v1,
                      https://api.anthropic.com/v1)
                    type: string
                  name:
                    description: Name is the model name (e.g. claude-sonnet, llama3:70b)
                    type: string
                type: object
              parentTaskId:
                description: ParentTaskID is the task ID of the parent task.
                type: string
              presidio:
                description: Presidio defines per-task Presidio overrides.
                properties:
                  action:
                    enum:
                    - redact
                    - detect
                    - hash
                    - mask
                    type: string
                  configRef:
                    description: ConfigRef is the name of a ConfigMap with custom
                      Presidio config.
                    type: string
                  scoreThreshold:
                    type: number
                type: object
              prompt:
                description: Prompt is the task instruction for the agent.
                minLength: 1
                type: string
              resources:
                description: Resources defines compute resources for the agent pod.
                properties:
                  limits:
                    description: ResourceList defines cpu and memory quantities.
                    properties:
                      cpu:
                        type: string
                      memory:
                        type: string
                    type: object
                  requests:
                    description: ResourceList defines cpu and memory quantities.
                    properties:
                      cpu:
                        type: string
                      memory:
                        type: string
                    type: object
                type: object
              retry:
                description: Retry defines retry behavior for transient failures.
                properties:
                  backoffSeconds:
                    default: 30
                    description: BackoffSeconds is the initial backoff duration (doubles
                      each attempt).
                    type: integer
                  maxAttempts:
                    default: 0
                    description: MaxAttempts is the maximum number of retry attempts
                      (0 = no retry).
                    type: integer
                  maxBackoffSeconds:
                    default: 300
                    description: MaxBackoffSeconds caps the exponential backoff.
                    type: integer
                type: object
              role:
                description: Role is a reference to an AgentRole or ClusterAgentRole
                  by name.
                type: string
              storage:
                description: Storage defines storage configuration overrides.
                properties:
                  retain:
                    default: false
                    description: Retain exempts PVC from TTL cleanup.
                    type: boolean
                  retainDays:
                    description: RetainDays is a custom TTL override in days.
                    type: integer
                  size:
                    default: 1Gi
                    description: Size is the PVC size (e.g. "1Gi"). Only applies to
                      tribune/centurion tiers.
                    type: string
                  storageClass:
                    description: StorageClass is the Kubernetes storage class name.
                    type: string
                type: object
              thinkingLevel:
                description: ThinkingLevel is the reasoning depth hint.
                enum:
                - low
                - medium
                - high
                type: string
              tier:
                default: legionary
                description: Tier is the agent hierarchy tier.
                enum:
                - tribune
                - centurion
                - legionary
                type: string
              timeout:
                default: 600
                description: Timeout is the task timeout in seconds.
                type: integer
            required:
            - prompt
            type: object
          status:
            description: AgentTaskStatus defines the observed state of AgentTask
            properties:
              attempts:
                description: Attempts is the number of execution attempts so far.
                type: integer
              childTasks:
                description: ChildTasks are the task IDs of spawned children.
                items:
                  type: string
                type: array
              completedAt:
                description: CompletedAt is when the task finished.
                format: date-time
                type: string
              conditions:
                description: Conditions represent the latest available observations.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              duration:
                description: Duration is the human-readable duration of the task.
                type: string
              estimatedCostUsd:
                description: EstimatedCostUsd is the estimated cost in USD.
                type: string
              hierarchyCostUsed:
                description: |-
                  HierarchyCostUsed tracks cumulative cost across the entire task tree.
                  Only populated on root tasks that define a HierarchyBudget.
                type: string
              hierarchyTokensUsed:
                description: |-
                  HierarchyTokensUsed tracks cumulative token usage across the entire task tree.
                  Only populated on root tasks that define a HierarchyBudget.
                properties:
                  input:
                    format: int64
                    type: integer
                  output:
                    format: int64
                    type: integer
                type: object
              history:
                description: History records each execution attempt.
                items:
                  description: AttemptRecord tracks a single execution attempt.
                  properties:
                    attempt:
                      description: Attempt number (1-indexed).
                      type: integer
                    endTime:
                      description: EndTime of this attempt.
                      format: date-time
                      type: string
                    exitCode:
                      description: ExitCode of the agent container.
                      format: int32
                      type: integer
                    reason:
                      description: Reason for the attempt outcome.
                      type: string
                    startTime:
                      description: StartTime of this attempt.
                      format: date-time
                      type: string
                  required:
                  - attempt
                  - startTime
                  type: object
                type: array
              lastReincarnatedAt:
                description: |-
                  LastReincarnatedAt records when the task was last reincarnated.
                  Used to filter out stale children from prior iterations during child discovery.
                format: date-time
                type: string
              message:
                description: Message provides human-readable status information.
                type: string
              nextRetryTime:
                description: NextRetryTime is when the next retry should be attempted.
                format: date-time
                type: string
              output:
                description: Output contains the result/output from the agent.
                type: string
              pendingChildren:
                description: PendingChildren tracks children the task is waiting on
                  (set when entering Waiting phase).
                items:
                  type: string
                type: array
              phase:
                description: Phase is the current phase of the task.
                enum:
                - Pending
                - Running
                - Waiting
                - Completed
                - Failed
                - BudgetExceeded
                - TimedOut
                - Cancelled
                - Retrying
                type: string
              podName:
                description: PodName is the name of the pod running this task.
                type: string
              startedAt:
                description: StartedAt is when the task started executing.
                format: date-time
                type: string
              tokensUsed:
                description: TokensUsed tracks token consumption.
                properties:
                  input:
                    format: int64
                    type: integer
                  output:
                    format: int64
                    type: integer
                type: object
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
