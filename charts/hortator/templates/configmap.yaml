apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "hortator.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "hortator.labels" . | nindent 4 }}
data:
  # Flat keys read directly by the operator controller
  presidioEnabled: {{ .Values.presidio.enabled | quote }}
  presidioEndpoint: {{ if .Values.presidio.enabled }}"http://{{ include "hortator.fullname" . }}-presidio.{{ .Release.Namespace }}.svc:3000"{{ else }}""{{ end }}
  presidioScoreThreshold: {{ .Values.presidio.scoreThreshold | quote }}
  warmPoolEnabled: {{ .Values.warmPool.enabled | quote }}
  warmPoolSize: {{ .Values.warmPool.size | quote }}
  resultCacheEnabled: {{ .Values.resultCache.enabled | quote }}
  resultCacheTTLSeconds: {{ .Values.resultCache.ttlSeconds | quote }}
  resultCacheMaxEntries: {{ .Values.resultCache.maxEntries | quote }}
  agenticImage: {{ include "hortator.agenticImage" . | quote }}
  {{- if .Values.litellm.enabled }}
  litellmEndpoint: {{ .Values.operator.litellmEndpoint | default (printf "http://%s-litellm:%v" .Release.Name (.Values.litellm.port | int)) | quote }}
  {{- end }}
  # Budget enforcement
  budgetEnabled: {{ .Values.budget.enabled | quote }}
  budgetDefaultMaxCostUsd: {{ .Values.budget.defaultLimit.maxCostUsd | quote }}
  budgetPriceSource: {{ .Values.budget.priceSource | quote }}
  budgetRefreshIntervalHours: {{ .Values.budget.refreshIntervalHours | quote }}
  budgetFallbackBehavior: {{ .Values.budget.fallbackBehavior | quote }}
  # Health / stuck detection
  healthEnabled: {{ .Values.health.enabled | quote }}
  healthCheckIntervalSeconds: {{ .Values.health.checkIntervalSeconds | quote }}
  stuckDetectionEnabled: {{ .Values.health.stuckDetection.enabled | quote }}
  stuckDetectionToolDiversityMin: {{ .Values.health.stuckDetection.defaults.toolDiversityMin | quote }}
  stuckDetectionMaxRepeatedPrompts: {{ .Values.health.stuckDetection.defaults.maxRepeatedPrompts | quote }}
  stuckDetectionStatusStaleMinutes: {{ .Values.health.stuckDetection.defaults.statusStaleMinutes | quote }}
  stuckDetectionCheckWindowMinutes: {{ .Values.health.stuckDetection.defaults.checkWindowMinutes | quote }}
  stuckDetectionAction: {{ .Values.health.stuckDetection.defaults.action | quote }}
  # Storage retained / knowledge discovery
  storageRetainedDiscovery: {{ .Values.storage.retained.discovery | quote }}
  storageRetainedAutoMount: {{ .Values.storage.retained.autoMount | quote }}
  storageRetainedMountMode: {{ .Values.storage.retained.mountMode | quote }}
  storageRetainedStaleAfterDays: {{ .Values.storage.retained.staleAfterDays | quote }}
  storageRetainedMaxPerNamespace: {{ .Values.storage.retained.maxRetainedPerNamespace | quote }}
  # Cleanup TTLs
  cleanupTTLCompleted: {{ .Values.storage.cleanup.ttl.completed | quote }}
  cleanupTTLFailed: {{ .Values.storage.cleanup.ttl.failed | quote }}
  cleanupTTLCancelled: {{ .Values.storage.cleanup.ttl.cancelled | quote }}
  # Agent defaults â€” the operator reads this at startup to configure
  # reconciliation behavior and default values for AgentTask Pods.
  config.yaml: |
    agent:
      image: {{ include "hortator.agentImage" . | quote }}
      agenticImage: {{ include "hortator.agenticImage" . | quote }}
      timeout: {{ .Values.agent.timeout | quote }}
      defaultTimeoutSeconds: {{ .Values.agent.defaultTimeoutSeconds }}
      resources:
        requests:
          cpu: {{ .Values.agent.resources.requests.cpu | quote }}
          memory: {{ .Values.agent.resources.requests.memory | quote }}
        limits:
          cpu: {{ .Values.agent.resources.limits.cpu | quote }}
          memory: {{ .Values.agent.resources.limits.memory | quote }}

    models:
      default:
        endpoint: {{ .Values.models.default.endpoint | quote }}
        name: {{ .Values.models.default.name | quote }}
      presets:
        ollama:
          enabled: {{ .Values.models.presets.ollama.enabled }}
          endpoint: {{ .Values.models.presets.ollama.endpoint | quote }}
        vllm:
          enabled: {{ .Values.models.presets.vllm.enabled }}
          endpoint: {{ .Values.models.presets.vllm.endpoint | quote }}
        litellm:
          enabled: {{ .Values.models.presets.litellm.enabled }}
          endpoint: {{ .Values.models.presets.litellm.endpoint | quote }}

    budget:
      enabled: {{ .Values.budget.enabled }}
      priceSource: {{ .Values.budget.priceSource | quote }}
      fallbackBehavior: {{ .Values.budget.fallbackBehavior | quote }}
      defaultLimit:
        maxCostUsd: {{ .Values.budget.defaultLimit.maxCostUsd | quote }}

    health:
      enabled: {{ .Values.health.enabled }}
      checkIntervalSeconds: {{ .Values.health.checkIntervalSeconds }}
      stuckDetection:
        enabled: {{ .Values.health.stuckDetection.enabled }}

    storage:
      storageClass: {{ .Values.storage.storageClass | quote }}
      defaultSize: {{ .Values.storage.defaultSize | quote }}

    presidio:
      enabled: {{ .Values.presidio.enabled }}
      image: {{ .Values.presidio.image | quote }}
      scoreThreshold: {{ .Values.presidio.scoreThreshold }}
      action: {{ .Values.presidio.action | quote }}
      model: {{ .Values.presidio.model | quote }}

    telemetry:
      enabled: {{ .Values.telemetry.enabled }}

    runtime:
      filesystem:
        enforceRequired: {{ .Values.runtime.filesystem.enforceRequired }}
      contextManagement:
        strategy: {{ .Values.runtime.contextManagement.strategy | quote }}
