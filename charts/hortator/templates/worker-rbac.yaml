{{/*
Worker RBAC (ServiceAccount, Role, RoleBinding) is now dynamically created
by the operator in each task's namespace via ensureWorkerRBAC(). This
template pre-provisions the resources in the operator namespace so that tasks
running in the same namespace as the operator work immediately.

For tasks in other namespaces, the operator creates these resources
automatically at reconcile time.
*/}}
{{- if .Values.workerRbac.create }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.workerRbac.serviceAccountName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "hortator.labels" . | nindent 4 }}
    app.kubernetes.io/name: hortator-worker
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ .Values.workerRbac.serviceAccountName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "hortator.labels" . | nindent 4 }}
    app.kubernetes.io/name: hortator-worker
rules:
  - apiGroups:
      - core.hortator.ai
    resources:
      - agenttasks
    verbs:
      - get
      - list
      - create
      - update
  - apiGroups:
      - core.hortator.ai
    resources:
      - agenttasks/status
    verbs:
      - get
      - update
      - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ .Values.workerRbac.serviceAccountName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "hortator.labels" . | nindent 4 }}
    app.kubernetes.io/name: hortator-worker
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ .Values.workerRbac.serviceAccountName }}
subjects:
  - kind: ServiceAccount
    name: {{ .Values.workerRbac.serviceAccountName }}
    namespace: {{ .Release.Namespace }}
{{- end }}
