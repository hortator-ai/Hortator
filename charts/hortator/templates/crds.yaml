{{- if .Values.crds.install }}
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: agenttasks.core.hortator.ai
  annotations:
    controller-gen.kubebuilder.io/version: v0.15.0
    {{- if .Values.crds.keep }}
    "helm.sh/resource-policy": keep
    {{- end }}
  labels:
    {{- include "hortator.labels" . | nindent 4 }}
spec:
  group: core.hortator.ai
  names:
    kind: AgentTask
    listKind: AgentTaskList
    plural: agenttasks
    singular: agenttask
    shortNames:
      - at
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
        - name: Pod
          type: string
          jsonPath: .status.podName
      schema:
        openAPIV3Schema:
          description: AgentTask is the Schema for the agenttasks API
          type: object
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              description: AgentTaskSpec defines the desired state of AgentTask
              type: object
              required:
                - prompt
              properties:
                prompt:
                  description: Prompt is the task instruction for the agent
                  type: string
                  minLength: 1
                capabilities:
                  description: Capabilities are the permissions/tools available to the agent
                  type: array
                  items:
                    type: string
                timeout:
                  description: Timeout is the maximum duration for task execution
                  type: string
                  default: "30m"
                image:
                  description: Image is the container image to use for the agent
                  type: string
                  default: "ghcr.io/hortator-ai/agent:latest"
                model:
                  description: Model is the LLM model to use
                  type: string
                env:
                  description: Environment variables to inject into the agent pod
                  type: object
                  additionalProperties:
                    type: string
                resources:
                  description: Resources defines compute resources for the agent pod
                  type: object
                  properties:
                    cpu:
                      description: CPU request
                      type: string
                    memory:
                      description: Memory request
                      type: string
            status:
              description: AgentTaskStatus defines the observed state of AgentTask
              type: object
              properties:
                phase:
                  description: Phase is the current phase of the task
                  type: string
                  enum:
                    - Pending
                    - Running
                    - Succeeded
                    - Failed
                output:
                  description: Output contains the result/output from the agent
                  type: string
                podName:
                  description: PodName is the name of the pod running this task
                  type: string
                startTime:
                  description: StartTime is when the task started executing
                  type: string
                  format: date-time
                completionTime:
                  description: CompletionTime is when the task finished
                  type: string
                  format: date-time
                message:
                  description: Message provides human-readable status information
                  type: string
                conditions:
                  description: Conditions represent the latest available observations
                  type: array
                  items:
                    type: object
                    required:
                      - lastTransitionTime
                      - message
                      - reason
                      - status
                      - type
                    properties:
                      lastTransitionTime:
                        type: string
                        format: date-time
                      message:
                        type: string
                      observedGeneration:
                        type: integer
                        format: int64
                      reason:
                        type: string
                      status:
                        type: string
                        enum:
                          - "True"
                          - "False"
                          - Unknown
                      type:
                        type: string
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: agentpolicies.core.hortator.ai
  annotations:
    controller-gen.kubebuilder.io/version: v0.15.0
    {{- if .Values.crds.keep }}
    "helm.sh/resource-policy": keep
    {{- end }}
  labels:
    {{- include "hortator.labels" . | nindent 4 }}
spec:
  group: core.hortator.ai
  names:
    kind: AgentPolicy
    listKind: AgentPolicyList
    plural: agentpolicies
    singular: agentpolicy
    shortNames:
      - ap
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      additionalPrinterColumns:
        - name: MaxTier
          type: string
          jsonPath: .spec.maxTier
        - name: RequirePresidio
          type: boolean
          jsonPath: .spec.requirePresidio
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      schema:
        openAPIV3Schema:
          description: AgentPolicy defines fine-grained restrictions for agent tasks in a namespace.
          type: object
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              description: AgentPolicySpec defines fine-grained restrictions for agent tasks.
              type: object
              properties:
                namespaceSelector:
                  type: object
                  properties:
                    matchLabels:
                      type: object
                      additionalProperties:
                        type: string
                    matchExpressions:
                      type: array
                      items:
                        type: object
                        required:
                          - key
                          - operator
                        properties:
                          key:
                            type: string
                          operator:
                            type: string
                          values:
                            type: array
                            items:
                              type: string
                allowedCapabilities:
                  type: array
                  items:
                    type: string
                deniedCapabilities:
                  type: array
                  items:
                    type: string
                allowedImages:
                  type: array
                  items:
                    type: string
                maxBudget:
                  type: object
                  properties:
                    maxTokens:
                      type: integer
                      format: int64
                    maxCostUsd:
                      type: string
                maxTimeout:
                  type: integer
                maxTier:
                  type: string
                  enum:
                    - legionary
                    - centurion
                    - tribune
                egressAllowlist:
                  type: array
                  items:
                    type: object
                    required:
                      - host
                    properties:
                      host:
                        type: string
                      ports:
                        type: array
                        items:
                          type: integer
                requirePresidio:
                  type: boolean
                maxConcurrentTasks:
                  type: integer
{{- end }}
