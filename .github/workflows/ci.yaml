name: CI

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

permissions:
  contents: write
  packages: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: "1.25"

      - uses: golangci/golangci-lint-action@v9
        with:
          version: v2.8.0

      - name: Helm lint
        run: helm lint charts/hortator

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: "1.25"

      - name: Install envtest binaries
        run: |
          go install sigs.k8s.io/controller-runtime/tools/setup-envtest@latest
          setup-envtest use

      - name: Run go vet
        run: go vet ./...

      - name: Run tests
        run: |
          export KUBEBUILDER_ASSETS="$(setup-envtest use -p path)"
          go test ./... -coverprofile=cover.out

      - name: Upload coverage
        uses: actions/upload-artifact@v6
        with:
          name: coverage
          path: cover.out

  e2e:
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: "1.25"

      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: hortator-e2e

      - name: Install envtest binaries
        run: |
          go install sigs.k8s.io/controller-runtime/tools/setup-envtest@latest
          setup-envtest use

      - name: Build and load images
        run: |
          docker build -t example.com/hortator:v0.0.1 .
          docker build -t example.com/hortator-agent:v0.0.1 -f runtime/Dockerfile .
          docker build -t example.com/hortator-agent-agentic:v0.0.1 -f runtime/agentic/Dockerfile .
          kind load docker-image example.com/hortator:v0.0.1 --name hortator-e2e
          kind load docker-image example.com/hortator-agent:v0.0.1 --name hortator-e2e
          kind load docker-image example.com/hortator-agent-agentic:v0.0.1 --name hortator-e2e

      - name: Run E2E tests
        run: |
          export KUBEBUILDER_ASSETS="$(setup-envtest use -p path)"
          go test ./test/e2e/ -tags=e2e -v -timeout 15m
        env:
          USE_EXISTING_CLUSTER: "true"
          KIND_CLUSTER: hortator-e2e

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: "1.25"

      - name: Go build
        run: go build ./...

      - name: Build operator image
        run: docker build -t hortator-operator:test .

      - name: Build runtime image
        run: docker build -t hortator-runtime:test -f runtime/Dockerfile .

      - name: Build agentic runtime image
        run: docker build -t hortator-agent-agentic:test -f runtime/agentic/Dockerfile .

  release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [lint, test, build]
    steps:
      - uses: actions/checkout@v6

      - name: Set tag
        id: tag
        run: echo "TAG=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push operator image
        run: |
          docker build -t ghcr.io/michael-niemand/hortator/operator:${{ steps.tag.outputs.TAG }} \
                        -t ghcr.io/michael-niemand/hortator/operator:latest .
          docker push ghcr.io/michael-niemand/hortator/operator:${{ steps.tag.outputs.TAG }}
          docker push ghcr.io/michael-niemand/hortator/operator:latest

      - name: Build and push runtime image
        run: |
          docker build -t ghcr.io/michael-niemand/hortator/runtime:${{ steps.tag.outputs.TAG }} \
                        -t ghcr.io/michael-niemand/hortator/runtime:latest \
                        -f runtime/Dockerfile .
          docker push ghcr.io/michael-niemand/hortator/runtime:${{ steps.tag.outputs.TAG }}
          docker push ghcr.io/michael-niemand/hortator/runtime:latest

      - name: Build and push agentic runtime image
        run: |
          docker build -t ghcr.io/michael-niemand/hortator/agent-agentic:${{ steps.tag.outputs.TAG }} \
                        -t ghcr.io/michael-niemand/hortator/agent-agentic:latest \
                        -f runtime/agentic/Dockerfile .
          docker push ghcr.io/michael-niemand/hortator/agent-agentic:${{ steps.tag.outputs.TAG }}
          docker push ghcr.io/michael-niemand/hortator/agent-agentic:latest

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true

      - name: Package and push Helm chart
        run: |
          helm package charts/hortator --version ${{ steps.tag.outputs.TAG }}
          helm push hortator-${{ steps.tag.outputs.TAG }}.tgz oci://ghcr.io/michael-niemand/hortator/charts
